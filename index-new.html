<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengingat Pembayaran</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>

<div x-data="paymentReminder()">
    <h1>Pengingat Pembayaran</h1>
    <form @submit.prevent="scheduleReminder">
        <label>
            Nomor WhatsApp:
            <input type="text" x-model="phoneNumber" placeholder="Contoh: 6281234567890" required>
        </label>
        <label>
            Tanggal Pembayaran:
            <input type="date" x-model="paymentDate" required>
        </label>
        <label>
            Waktu Pengingat:
            <input type="time" x-model="reminderTime" required>
        </label>
        <button type="submit" x-show="!isEditing">Setel Pengingat</button>
        <button type="button" @click="updateReminder()" x-show="isEditing">Perbarui Pengingat</button>
    </form>

    <div x-show="message">
        <p x-text="message"></p>
    </div>

    <!-- Daftar Pengingat -->
    <h2>Jadwal Pengingat Terdaftar</h2>
    <button @click="fetchReminders">Tampilkan Pengingat</button>
    <ul>
        <template x-for="reminder in reminders" :key="reminder.id">
            <li>
                <strong x-text="reminder.phoneNumber"></strong> - 
                <span x-text="new Date(reminder.reminderDateTime).toLocaleString()"></span>
                <button @click="editReminder(reminder)">Edit</button>
                <button @click="deleteReminder(reminder.id)">Hapus</button>
            </li>
        </template>
    </ul>
</div>

<script>
function paymentReminder() {
    return {
        phoneNumber: '',
        paymentDate: '',
        reminderTime: '',
        message: '',
        reminders: [],
        isEditing: false,
        currentReminderId: null,

        // Fungsi untuk menjadwalkan pengingat
        scheduleReminder() {
            fetch('http://localhost:3000/schedule-reminder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phoneNumber: this.phoneNumber,
                    paymentDate: this.paymentDate,
                    reminderTime: this.reminderTime,
                }),
            })
            .then(async (response) => {
                if (!response.ok) {
                    const errorMessage = await response.json();
                    throw new Error(errorMessage.message || 'Terjadi kesalahan pada server');
                }
                return response.json();
            })
            .then(data => {
                this.message = data.message;
                this.fetchReminders(); // Refresh daftar pengingat setelah menambah pengingat baru
            })
            .catch(error => {
                this.message = 'Terjadi kesalahan: ' + error.message;
            });
        },

        // Fungsi untuk mengambil daftar pengingat
        fetchReminders() {
            fetch('http://localhost:3000/get-reminders')
                .then(response => response.json())
                .then(data => {
                    this.reminders = data.reminders;
                })
                .catch(error => {
                    console.error('Error mengambil pengingat:', error);
                });
        },

        // Fungsi untuk mengedit pengingat
        editReminder(reminder) {
            this.phoneNumber = reminder.phoneNumber;
            this.paymentDate = new Date(reminder.reminderDateTime).toISOString().split('T')[0];
            this.reminderTime = new Date(reminder.reminderDateTime).toISOString().split('T')[1].slice(0, 5);
            this.isEditing = true;
            this.currentReminderId = reminder.id;
        },

        // Fungsi untuk memperbarui pengingat
        updateReminder() {
            fetch(`http://localhost:3000/update-reminder/${this.currentReminderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phoneNumber: this.phoneNumber,
                    paymentDate: this.paymentDate,
                    reminderTime: this.reminderTime,
                }),
            })
            .then(async (response) => {
                if (!response.ok) {
                    const errorMessage = await response.json();
                    throw new Error(errorMessage.message || 'Terjadi kesalahan pada server');
                }
                return response.json();
            })
            .then(data => {
                this.message = data.message;
                this.fetchReminders(); // Refresh daftar pengingat setelah memperbarui pengingat
                this.resetForm();
            })
            .catch(error => {
                this.message = 'Terjadi kesalahan: ' + error.message;
            });
        },

        // Fungsi untuk menghapus pengingat
        deleteReminder(id) {
            fetch(`http://localhost:3000/delete-reminder/${id}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                this.message = data.message;
                this.fetchReminders(); // Refresh daftar pengingat setelah menghapus pengingat
            })
            .catch(error => {
                console.error('Error menghapus pengingat:', error);
            });
        },

        // Fungsi untuk mereset form setelah edit atau tambah pengingat
        resetForm() {
            this.phoneNumber = '';
            this.paymentDate = '';
            this.reminderTime = '';
            this.isEditing = false;
            this.currentReminderId = null;
        }
    }
}
</script>

</body>
</html>
