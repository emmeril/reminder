<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Reminder</title>
  <script src="//unpkg.com/alpinejs" defer></script>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>

<div x-data="reminderApp()" class="container mt-5">
  <h1 class="text-center mb-4">WhatsApp Reminder Scheduler</h1>

  <!-- Form untuk menambahkan atau memperbarui pengingat -->
  <form @submit.prevent="isEditing ? updateReminder() : scheduleReminder()" class="mb-4">
    <div class="form-row">
      <div class="form-group col-md-6">
        <label>Phone Number:</label>
        <input type="text" x-model="newReminder.phoneNumber" class="form-control" required>
      </div>
      <div class="form-group col-md-6">
        <label>Payment Date:</label>
        <input type="date" x-model="newReminder.paymentDate" class="form-control" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <label>Reminder Time:</label>
        <input type="time" x-model="newReminder.reminderTime" class="form-control" required>
      </div>
      <div class="form-group col-md-6">
        <label>Message:</label>
        <input type="text" x-model="newReminder.message" class="form-control" required>
      </div>
    </div>

    <button type="submit" class="btn btn-primary" x-text="isEditing ? 'Update Reminder' : 'Schedule Reminder'"></button>
    <button type="button" @click="resetForm" class="btn btn-secondary" x-show="isEditing">Cancel</button>
  </form>

  <hr>

  <!-- Daftar pengingat yang telah dijadwalkan -->
  <h2 class="mb-3">Scheduled Reminders</h2>
  <ul class="list-group">
    <template x-for="reminder in reminders" :key="reminder.id">
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong x-text="reminder.phoneNumber"></strong><br>
          <small x-text="new Date(reminder.reminderDateTime).toLocaleString()" ></small><br>
          <span x-text="reminder.message"></span>
        </div>
        <div>
          <button @click="editReminder(reminder)" class="btn btn-warning btn-sm mr-2">Edit</button>
          <button @click="deleteReminder(reminder.id)" class="btn btn-danger btn-sm">Delete</button>
        </div>
      </li>
    </template>
  </ul>

  <!-- Pagination Controls -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      <li class="page-item" :class="{'disabled': currentPage === 1}">
        <button class="page-link" @click="goToPage(1)" aria-label="First">
          <span aria-hidden="true">&laquo;&laquo;</span>
        </button>
      </li>
      <li class="page-item" :class="{'disabled': currentPage === 1}">
        <button class="page-link" @click="goToPage(currentPage - 1)" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </button>
      </li>
      <template x-for="page in totalPages" :key="page">
        <li class="page-item" :class="{'active': currentPage === page}">
          <button class="page-link" @click="goToPage(page)" x-text="page"></button>
        </li>
      </template>
      <li class="page-item" :class="{'disabled': currentPage === totalPages}">
        <button class="page-link" @click="goToPage(currentPage + 1)" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </button>
      </li>
      <li class="page-item" :class="{'disabled': currentPage === totalPages}">
        <button class="page-link" @click="goToPage(totalPages)" aria-label="Last">
          <span aria-hidden="true">&raquo;&raquo;</span>
        </button>
      </li>
    </ul>
  </nav>
</div>

<script>
  function reminderApp() {
    return {
      reminders: [],
      newReminder: {
        phoneNumber: '',
        paymentDate: '',
        reminderTime: '',
        message: ''
      },
      isEditing: false,
      editId: null,
      currentPage: 1,
      totalPages: 1,
      limit: 5,

      async fetchReminders(page = 1) {
        try {
          const response = await fetch(`http://localhost:3000/get-reminders?page=${page}&limit=${this.limit}`);
          const data = await response.json();
          this.reminders = data.reminders;
          this.currentPage = data.page;
          this.totalPages = data.totalPages;
        } catch (error) {
          console.error("Error fetching reminders:", error);
        }
      },

      async scheduleReminder() {
        try {
          const response = await fetch('http://localhost:3000/schedule-reminder', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(this.newReminder)
          });
          const data = await response.json();
          if (response.ok) {
            await this.fetchReminders(this.currentPage);
            this.resetForm();
          } else {
            console.error(data.message);
          }
        } catch (error) {
          console.error("Error scheduling reminder:", error);
        }
      },

      async updateReminder() {
        try {
          const response = await fetch(`http://localhost:3000/update-reminder/${this.editId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(this.newReminder)
          });
          const data = await response.json();
          if (response.ok) {
            await this.fetchReminders(this.currentPage);
            this.resetForm();
          } else {
            console.error(data.message);
          }
        } catch (error) {
          console.error("Error updating reminder:", error);
        }
      },

      async deleteReminder(id) {
        try {
          const response = await fetch(`http://localhost:3000/delete-reminder/${id}`, {
            method: 'DELETE'
          });
          if (response.ok) {
            await this.fetchReminders(this.currentPage);
          } else {
            console.error("Failed to delete reminder");
          }
        } catch (error) {
          console.error("Error deleting reminder:", error);
        }
      },

      editReminder(reminder) {
        this.newReminder = { ...reminder };
        this.isEditing = true;
        this.editId = reminder.id;
      },

      resetForm() {
        this.newReminder = {
          phoneNumber: '',
          paymentDate: '',
          reminderTime: '',
          message: ''
        };
        this.isEditing = false;
        this.editId = null;
      },

      goToPage(page) {
        if (page >= 1 && page <= this.totalPages) {
          this.fetchReminders(page);
        }
      },

      async init() {
        await this.fetchReminders();
      }
    };
  }
</script>

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>
